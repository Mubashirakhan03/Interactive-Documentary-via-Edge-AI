<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech Synthesis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">

    <script>
        // Predefined average time per sentence (in seconds)
        const AVERAGE_TIME_PER_SENTENCE = 2.5;

        function estimateTime(text) {
            // Split text into sentences
            const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
            const numberOfSentences = sentences.length;

            // Calculate the estimated total time
            const estimatedTime = numberOfSentences * AVERAGE_TIME_PER_SENTENCE;

            return estimatedTime;
        }

        function updateSpeakers() {
            var languageSelect = document.getElementById('languageSelect');
            var selectedLanguage = languageSelect.value;
            var speakers = JSON.parse(document.getElementById('speakersData').textContent);
            var speakerSelect = document.getElementById('speakerSelect');
            speakerSelect.innerHTML = '';  // Clear previous options

            if (speakers[selectedLanguage]) {
                speakers[selectedLanguage].forEach(function(speaker) {
                    var option = document.createElement('option');
                    option.value = speaker.voice_id;
                    option.text = speaker.name;
                    speakerSelect.appendChild(option);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('languageSelect').addEventListener('change', updateSpeakers);
            updateSpeakers();  // Initialize speakers on page load

            document.getElementById('synthesizeForm').addEventListener('submit', function(event) {
                event.preventDefault();
                synthesizeText();
            });
        });

        function synthesizeText() {
            var form = document.getElementById('synthesizeForm');
            var formData = new FormData(form);
            var jsonData = {};
            formData.forEach((value, key) => jsonData[key] = value);

            // Estimate the total time
            const estimatedTime = estimateTime(jsonData.text);
            document.getElementById('estimatedTime').textContent = `Estimated time: ${estimatedTime.toFixed(2)} seconds`;

            // Disable the form and show loading message
            Array.from(form.elements).forEach(element => element.disabled = true);
            var loadingMessage = document.createElement('p');
            loadingMessage.id = 'loadingMessage';
            loadingMessage.innerText = 'Loading...';
            form.appendChild(loadingMessage);

            fetch('/synthesize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let receivedLength = 0; // progress received
                let buffer = ''; // buffer to hold incoming chunks

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            loadingMessage.innerText = 'Completed!';
                            return;
                        }

                        receivedLength += value.length;
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;

                        let boundary = buffer.indexOf('\n');
                        while (boundary !== -1) {
                            const jsonChunk = buffer.slice(0, boundary);
                            buffer = buffer.slice(boundary + 1);

                            try {
                                const data = JSON.parse(jsonChunk);
                                if (data.progress) {
                                    loadingMessage.innerText = `Progress: ${data.progress.toFixed(2)}%`;
                                } else if (data.redirect_url) {
                                    window.location.href = data.redirect_url;
                                } else if (data.error) {
                                    alert('Synthesis failed: ' + data.error);
                                    Array.from(form.elements).forEach(element => element.disabled = false);
                                    loadingMessage.remove();
                                }
                            } catch (e) {
                                console.error('Error parsing JSON:', e);
                            }

                            boundary = buffer.indexOf('\n');
                        }

                        read();
                    });
                }

                read();
            })
            .catch(error => {
                alert('Error: ' + error);
                // Re-enable the form if an error occurred
                Array.from(form.elements).forEach(element => element.disabled = false);
                loadingMessage.remove();
            });
        }
    </script>
</head>
<body>
    <h1>Text-to-Speech Synthesis</h1>
    <form id="synthesizeForm">
        <label for="languageSelect">Select Language:</label>
        <select id="languageSelect" name="language">
            {% for model_id, language in languages.items() %}
                <option value="{{ model_id }}">{{ language }}</option>
            {% endfor %}
        </select>

        <label for="speakerSelect">Select Speaker:</label>
        <select id="speakerSelect" name="speaker">
            <!-- Options will be populated by JavaScript -->
        </select>

        <label for="text">Text:</label>
        <textarea id="text" name="text" rows="4" cols="50">{{ extracted_text }}</textarea>

        <button type="submit">Synthesize</button>
    </form>

    <div id="estimatedTime"></div>

    <script id="speakersData" type="application/json">
        {{ speakers | tojson }}
    </script>
</body>
</html>
